<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calendario de Reservas</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">



</head>

<style>
    body {
        background-color: #0f0f0f;
        color: #f1c40f;
    }
    #calendar {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        min-height: 700px;
    }
    h1 {
        color: #f1c40f;
        font-weight: bold;
        text-align: center;
        margin-bottom: 25px;
    }
</style>

<body class="bg-dark text-white">
<div class="container py-4">
    <h1 class="text-warning text-center mb-4">Reservas De Canchas</h1>

    <div id="calendar" class="bg-white rounded p-3 text-dark shadow"></div>
</div>

<!-- Modal Nueva Reserva -->
<div class="modal fade" id="modalReserva" tabindex="-1">
  <div class="modal-dialog">
    <form id="formReserva" class="modal-content bg-secondary text-white">
      <div class="modal-header">
        <h5 class="modal-title">Nueva Reserva</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-2">
            <label>Fecha:</label>
            <input type="date" id="fecha" name="fecha" class="form-control" required>
        </div>

        <div class="mb-2">
            <label>Hora de inicio:</label>
            <input type="time" id="hora_inicio" name="hora_inicio" class="form-control" required>
        </div>

        <div class="mb-2">
            <label>Hora de término:</label>
            <input type="time" id="hora_fin" name="hora_fin" class="form-control" required>
        </div>

        <div class="mb-2">
            <label>Socio:</label>
            <select id="socio" name="socio" class="form-select" required>
                {% for s in socios %}
                <option value="{{ s.id }}">{{ s.nombre }} {{ s.apellido_paterno }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-2">
            <label>Cancha:</label>
            <select id="cancha" name="cancha" class="form-select" required>
                {% for c in canchas %}
                <option value="{{ c.id }}">{{ c.nombre }} ({{ c.get_tipo_display }})</option>
                {% endfor %}
            </select>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-warning">Guardar Reserva</button>
      </div>
    </form>
  </div>
</div>

<!-- JS Bootstrap y lógica del calendario -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const modalEl = document.getElementById('modalReserva');
  const form = document.getElementById('formReserva');
  const modal = new bootstrap.Modal(modalEl);

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    locale: 'es',
    selectable: true,
    selectMirror: true,
    nowIndicator: true,
    height: 'auto',
    expandRows: true,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    events: '/reservas/api/reservas/',
    select: function(info) {
      // Abrir modal con fecha y hora pre-rellenadas
      const fecha = info.startStr.split("T")[0];
      const horaInicio = info.startStr.split("T")[1]?.substring(0,5) || "";
      const horaFin = info.endStr.split("T")[1]?.substring(0,5) || "";

      document.getElementById('fecha').value = fecha;
      document.getElementById('hora_inicio').value = horaInicio;
      document.getElementById('hora_fin').value = horaFin;

      modal.show();
    },
    eventColor: '#f1c40f'
  });

  // Guardar reserva vía API
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = {
      socio: document.getElementById('socio').value,
      cancha: document.getElementById('cancha').value,
      fecha: document.getElementById('fecha').value,
      hora_inicio: document.getElementById('hora_inicio').value,
      hora_fin: document.getElementById('hora_fin').value
    };

    try {
      await axios.post('/reservas/api/reservas/nueva/', data);
      modal.hide();
      calendar.refetchEvents();
      alert('✅ Reserva creada correctamente.');
    } catch (error) {
      console.error(error);
      alert('⚠️ ' + (error.response?.data?.error || 'Error al crear la reserva'));
    }
  });

  calendar.render();
});
</script>

</body>
</html>
