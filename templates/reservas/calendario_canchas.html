{% extends 'users/base_dashboard.html' %}
{% load static %}

{% block title %}Reservas de Canchas{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold text-dark">üèüÔ∏è Reservas de Canchas</h3>
  </div>

  <div id="calendar" class="bg-white p-3 rounded shadow-sm"></div>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalReserva" tabindex="-1" aria-labelledby="modalReservaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="formReserva">
        {% csrf_token %}
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">Nueva Reserva</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Socio</label>
            <select name="socio" class="form-select" required>
              {% for socio in socios %}
                <option value="{{ socio.id }}">{{ socio.nombre }} {{ socio.apellido_paterno }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Cancha</label>
            <select name="cancha" class="form-select" required>
              {% for cancha in canchas %}
                <option value="{{ cancha.id }}">{{ cancha.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Fecha</label>
            <input type="date" name="fecha" id="fecha" class="form-control" required>
          </div>

          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Hora inicio</label>
              <input type="time" name="hora_inicio" class="form-control" required step="3600" min="08:00" max="22:00">
            </div>
            <div class="col-md-6">
              <label class="form-label">Hora fin</label>
              <input type="time" name="hora_fin" class="form-control" required step="3600" min="08:00" max="22:00">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-warning fw-bold">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Scripts al final del dashboard -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const modal = new bootstrap.Modal(document.getElementById('modalReserva'));

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'es',
    height: 'auto',
    events: "{% url 'eventos_canchas_json' %}",
    dateClick: function(info) {
      document.getElementById('fecha').value = info.dateStr;
      modal.show();
    }
  });
  calendar.render();

  // Enviar formulario AJAX
  document.getElementById('formReserva').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const response = await fetch("{% url 'crear_reserva_ajax' %}", {
      method: "POST",
      body: formData,
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    });
    const data = await response.json();
    if (data.status === 'success') {
      Swal.fire('‚úÖ √âxito', data.message, 'success');
      modal.hide();
      calendar.refetchEvents();
    } else {
      Swal.fire('‚ùå Error', data.message, 'error');
    }
  });
});
</script>
{% endblock %}
