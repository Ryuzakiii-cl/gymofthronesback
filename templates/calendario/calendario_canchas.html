{% extends 'core/base_dashboard.html' %}
{% load static %}
{% block title %}Reservas de Canchas{% endblock %}

{% block content %}
<div class="card shadow p-4">
  <h3 class="mb-4 text-dark fw-bold">üèüÔ∏è Reservas de Canchas</h3>
  <div id="calendar"></div>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalReserva" tabindex="-1" aria-labelledby="modalReservaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formReserva">
        {% csrf_token %}
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="modalReservaLabel">Nueva Reserva</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="reserva_id" id="reserva_id">

          <div class="mb-3">
            <label class="form-label">Socio</label>
            <select name="socio" class="form-select" required>
              <option value="">-- Selecciona socio --</option>
              {% for socio in socios %}
                <option value="{{ socio.id }}">{{ socio.nombre }} {{ socio.apellido_paterno }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Cancha</label>
            <select name="cancha" class="form-select" required>
              <option value="">-- Selecciona cancha --</option>
              {% for cancha in canchas %}
                <option value="{{ cancha.id }}">{{ cancha.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Fecha</label>
            <input type="date" name="fecha" id="fecha" class="form-control" required>
          </div>
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Hora inicio</label>
              <input type="time" name="hora_inicio" class="form-control" required step="3600" min="08:00" max="22:00">
            </div>
            <div class="col-md-6">
              <label class="form-label">Hora fin</label>
              <input type="time" name="hora_fin" class="form-control" required step="3600" min="08:00" max="22:00">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-warning">Guardar</button>
          <button type="button" id="btnEliminar" class="btn btn-danger d-none">Eliminar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  #calendar {
    min-height: 720px !important;
    background-color: #fff;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  }
  .fc { --fc-border-color: #e9ecef; font-size: 0.95rem; }
  .fc-toolbar-title { font-weight: 700; color: #222; }
  .fc .fc-daygrid-day { height: 100px !important; }
</style>

<script>
window.addEventListener('load', function() {
  const calendarEl = document.getElementById('calendar');
  const modalEl = document.getElementById('modalReserva');
  const modal = new bootstrap.Modal(modalEl);
  const form = document.getElementById('formReserva');
  const btnEliminar = document.getElementById('btnEliminar');

  // *** SOLUCI√ìN: Obtenemos el token CSRF desde el DOM ***
  // Lo leemos del input que gener√≥ {% csrf_token %}
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // --- CALENDARIO ---
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'es',
    firstDay: 1,
    slotDuration: '01:00:00',
    slotMinTime: '08:00:00',
    slotMaxTime: '22:00:00',
    height: 'auto',
    headerToolbar: {
    left: 'prev,next today',
    center: 'title',
    right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    events: "{% url 'eventos_canchas_json' %}",


    // Crear reserva
    dateClick: function(info) {
      form.reset();
      document.getElementById('modalReservaLabel').textContent = "Nueva Reserva";
      document.getElementById('reserva_id').value = '';
      btnEliminar.classList.add('d-none');
      document.getElementById('fecha').value = info.dateStr;
      modal.show();
    },

    // Editar reserva
    eventClick: function(info) {
      const e = info.event;
      const p = e.extendedProps;

      document.getElementById('modalReservaLabel').textContent = "Editar Reserva";
      document.getElementById('reserva_id').value = p.id;
      document.querySelector('[name=socio]').value = p.socio_id;
      document.querySelector('[name=cancha]').value = p.cancha_id;
      document.querySelector('[name=fecha]').value = e.startStr.split('T')[0];
      document.querySelector('[name=hora_inicio]').value = p.hora_inicio.slice(0,5);
      document.querySelector('[name=hora_fin]').value = p.hora_fin.slice(0,5);
      btnEliminar.classList.remove('d-none');

      modal.show();
    }
  });

  calendar.render();

  // --- GUARDAR RESERVA ---
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    const id = document.getElementById('reserva_id').value;
    const url = id 
      ? `/canchas/api/reservas/editar/${id}/`
      : "{% url 'crear_reserva_ajax' %}";


    const response = await fetch(url, {
      method: "POST",
      body: formData,
      // *** CORRECCI√ìN: Se elimina el 'headers' ***
      // FormData ya incluye el token CSRF desde el input oculto.
    });

    const data = await response.json();
    if (data.status === 'success') {
      Swal.fire('‚úÖ √âxito', data.message, 'success');
      modal.hide();
      calendar.refetchEvents(); // <-- Mejora: Se quita el setTimeout
    } else {
      Swal.fire('‚ùå Error', data.message || 'No se pudo guardar la reserva', 'error');
    }
  });

  // --- ELIMINAR RESERVA ---
  btnEliminar.addEventListener('click', async function() {
    const id = document.getElementById('reserva_id').value;
    if (!id) return;

    const confirm = await Swal.fire({
      title: '¬øEliminar reserva?',
      text: 'Esta acci√≥n no se puede deshacer',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'S√≠, eliminar'
    });

    if (!confirm.isConfirmed) return;

    const response = await fetch(`/canchas/api/reservas/eliminar/${id}/`, {
      method: "POST",
      // *** CORRECCI√ìN: Usamos la variable csrfToken que le√≠mos del DOM ***
      headers: { 'X-CSRFToken': csrfToken }
    });
    const data = await response.json();

    if (data.status === 'success') {
      Swal.fire('üóëÔ∏è Eliminada', data.message, 'success');
      modal.hide();
      calendar.refetchEvents(); // <-- Mejora: Se quita el setTimeout
    } else {
      Swal.fire('‚ùå Error', data.message || 'No se pudo eliminar la reserva', 'error');
    }
  });

});
</script>
{% endblock %}